# NIXL Container Build Configuration
# Builds and pushes NIXL and NIXLBench containers with configurable NIXL/UCX versions

---
job: nixl-ci-build-container

# Build settings
failFast: false
timeout_minutes: 240

# Infrastructure
kubernetes:
  cloud: il-ipp-blossom-prod
  namespace: nbu-swx-nixl
  limits: "{memory: 16Gi, cpu: 8000m}"
  requests: "{memory: 8Gi, cpu: 4000m}"

runs_on_dockers:
  - { name: "podman-v5.7.1", url: "quay.io/podman/stable:v5.7.1", privileged: true }

# Build matrix
matrix:
  axes:
    arch:
      - x86_64
      - aarch64

# Configuration
env:
  REGISTRY_HOSTESS: "artifactory.nvidia.com"
  REGISTRY_HOSTESS_OLD: "urm.nvidia.com"
  REGISTRY_REPO: "sw-nbu-swx-nixl-docker-local/verification"
  LOCAL_TAG_BASE: "nixl-ci:build-"
  MAIL_FROM: "jenkins@nvidia.com"

taskName: "${BUILD_TARGET}/${arch}/${axis_index}"

credentials:
  - credentialsId: 'svc-nixl-new-artifactory-token'
    # Preserve historical variable names for the primary registry push logic
    usernameVariable: 'ARTIFACTORY_USERNAME'
    passwordVariable: 'ARTIFACTORY_PASSWORD'
  - credentialsId: 'svc-nixl-artifactory-token'
    usernameVariable: 'ARTIFACTORY_OLD_USERNAME'
    passwordVariable: 'ARTIFACTORY_OLD_PASSWORD'

pipeline_start:
  shell: action
  module: groovy
  run: |
    def suffix = params.TAG_SUFFIX ? "-${params.TAG_SUFFIX}" : ""
    def buildName = params.BUILD_TARGET
    currentBuild.displayName += "-${buildName}-${params.NIXL_VERSION}-${params.UCX_VERSION}${suffix}"
    env.ENABLE_NIXL_BUILD = params.BUILD_TARGET == 'nixl' ? 'true' : 'false'
    env.ENABLE_NIXLBENCH_BUILD = params.BUILD_TARGET == 'nixlbench' ? 'true' : 'false'
    echo "ENABLE_NIXL_BUILD: ${env.ENABLE_NIXL_BUILD}"
    echo "ENABLE_NIXLBENCH_BUILD: ${env.ENABLE_NIXLBENCH_BUILD}"
    echo "BUILD_TARGET: ${params.BUILD_TARGET}"
    echo "BUILD_NIXL_EP: ${params.BUILD_NIXL_EP}"

# Build pipeline
steps:
  - name: Prepare
    run: |
      # Setup podman and dependencies
      set -x
      rm -f /etc/containers/storage.conf /usr/share/containers/storage.conf
      podman system reset -f || true
      podman info
      ln -sfT $(type -p podman) /usr/bin/docker
      yum install -y gettext

  - name: Build NIXLBench
    enable: ${ENABLE_NIXLBENCH_BUILD}
    run: |
      # Clone UCX source for nixlbench
      git clone https://github.com/openucx/ucx.git ucx-src
      git -C ucx-src checkout "${UCX_VERSION}"

      "benchmark/nixlbench/contrib/build.sh" \
        --base-image "${BASE_IMAGE}" \
        --base-image-tag "${BASE_IMAGE_TAG}" \
        --tag "${LOCAL_TAG_BASE}${arch}" \
        --arch "${arch}" \
        --no-cache \
        --nixl "$WORKSPACE" \
        --ucx "$WORKSPACE/ucx-src"

  - name: Build NIXL
    enable: ${ENABLE_NIXL_BUILD}
    run: |
      export UCX_REF="${UCX_VERSION}"

      NIXL_EP_FLAG=""
      if [[ "${BUILD_NIXL_EP}" == "true" ]]; then
          NIXL_EP_FLAG="--build-nixl-ep"
      fi

      "contrib/build-container.sh" \
        --base-image "${BASE_IMAGE}" \
        --base-image-tag "${BASE_IMAGE_TAG}" \
        --tag "${LOCAL_TAG_BASE}${arch}" \
        --arch "${arch}" \
        --build-type debug \
        --no-cache \
        ${NIXL_EP_FLAG}

  - name: Add Version Info
    run: |
      git config --global --add safe.directory '*'
      # Extract standardized 8-char commit hash for UCX version info:
      if [[ "$BUILD_TARGET" == "nixlbench" ]]; then
        CLEAN_UCX=$(cd "$WORKSPACE/ucx-src" && git rev-parse --short=8 HEAD)
      else
        UCX_REF="$UCX_VERSION"

        # Hash? if yes truncate, else ls-remote then truncate
        if [[ "$UCX_REF" =~ ^[a-f0-9]{8,40}$ ]]; then
          CLEAN_UCX="${UCX_REF:0:8}"
        else
          CLEAN_UCX=$(git ls-remote https://github.com/openucx/ucx.git "$UCX_REF" | head -n1 | cut -c1-8)
        fi

        # Verify
        [[ -n "$CLEAN_UCX" ]] || { echo "ERROR: failed to resolve UCX_REF=$UCX_REF"; exit 1; }
      fi

      # Calculate tag name
      NIXL_VERSION="$(git rev-parse --short=8 HEAD)"
      TAG_NAME="${BASE_IMAGE_TAG}-nixl-${NIXL_VERSION}-ucx-${CLEAN_UCX}-${arch}${TAG_SUFFIX:+-${TAG_SUFFIX}}"

      # Generate version info file from template
      export BUILD_TIMESTAMP="$(date -u '+%Y-%m-%dT%H:%M:%SZ')" \
             BUILD_TARGET BASE_IMAGE BASE_IMAGE_TAG arch \
             BUILD_NUMBER BUILD_URL JOB_NAME NODE_NAME WORKSPACE \
             NIXL_VERSION UCX_VERSION="${CLEAN_UCX}" TAG_NAME
      envsubst < .ci/assets/nixl-version-info.template > version-info

      # Add version info to the image
      docker run -itd --name tempcontainer "${LOCAL_TAG_BASE}${arch}"
      docker cp version-info "tempcontainer:/opt/nixl-version"
      docker commit tempcontainer "${LOCAL_TAG_BASE}${arch}"
      docker rm -f tempcontainer || true

  - name: Push
    credentialsId: 'svc-nixl-new-artifactory-token'
    run: |
      source version-info
      ARTIFACTORY_REGISTRY="${REGISTRY_HOSTESS}/${REGISTRY_REPO}/${BUILD_TARGET}"
      ARTIFACTORY_API="https://${REGISTRY_HOSTESS}/artifactory/api/storage/${REGISTRY_REPO}/${BUILD_TARGET}"

      # Prepare image properties
      IMAGE_PROPERTIES="BUILD_TARGET=${BUILD_TARGET};NIXL_VERSION=${NIXL_VERSION};UCX_VERSION=${UCX_VERSION};arch=${arch};"
      IMAGE_PROPERTIES+="BUILD_NUMBER=${BUILD_NUMBER};JOB_NAME=${JOB_NAME};BUILD_URL=${BUILD_URL};NODE_NAME=${NODE_NAME};"
      IMAGE_PROPERTIES+="BASE_IMAGE=${BASE_IMAGE};BASE_IMAGE_TAG=${BASE_IMAGE_TAG}"

      [[ -n "${ARTIFACTORY_USERNAME:-}" ]] || { echo "ERROR: ARTIFACTORY_USERNAME is empty"; exit 1; }
      [[ -n "${ARTIFACTORY_PASSWORD:-}" ]] || { echo "ERROR: ARTIFACTORY_PASSWORD is empty"; exit 1; }

      # Login to new Artifactory
      echo "$ARTIFACTORY_PASSWORD" | docker login "${REGISTRY_HOSTESS}" -u "$ARTIFACTORY_USERNAME" --password-stdin

      # Function to tag, push, and set properties (new Artifactory)
      tag_push_set_properties() {
        local target_tag="$1"
        echo "Creating tag: ${target_tag}"
        docker tag "${LOCAL_TAG_BASE}${arch}" "${ARTIFACTORY_REGISTRY}:${target_tag}"
        docker push "${ARTIFACTORY_REGISTRY}:${target_tag}"
        curl -H "Authorization: Bearer ${ARTIFACTORY_PASSWORD}" -X PUT \
          "${ARTIFACTORY_API}/${target_tag}?properties=${IMAGE_PROPERTIES}"
      }

      # Always create standard tag (new Artifactory)
      tag_push_set_properties "${TAG_NAME}"

      # Check if latest tag should be updated (new Artifactory)
      if [[ "${UPDATE_LATEST}" == "true" ]]; then
        tag_push_set_properties "${BASE_IMAGE_TAG}-${arch}-latest"
      fi

  - name: Push (old Artifactory)
    credentialsId: 'svc-nixl-artifactory-token'
    run: |
      source version-info
      ARTIFACTORY_REGISTRY_OLD="${REGISTRY_HOSTESS_OLD}/${REGISTRY_REPO}/${BUILD_TARGET}"
      ARTIFACTORY_API_OLD="https://${REGISTRY_HOSTESS_OLD}/artifactory/api/storage/${REGISTRY_REPO}/${BUILD_TARGET}"

      # Prepare image properties
      IMAGE_PROPERTIES="BUILD_TARGET=${BUILD_TARGET};NIXL_VERSION=${NIXL_VERSION};UCX_VERSION=${UCX_VERSION};arch=${arch};"
      IMAGE_PROPERTIES+="BUILD_NUMBER=${BUILD_NUMBER};JOB_NAME=${JOB_NAME};BUILD_URL=${BUILD_URL};NODE_NAME=${NODE_NAME};"
      IMAGE_PROPERTIES+="BASE_IMAGE=${BASE_IMAGE};BASE_IMAGE_TAG=${BASE_IMAGE_TAG}"

      [[ -n "${ARTIFACTORY_OLD_USERNAME:-}" ]] || { echo "ERROR: ARTIFACTORY_OLD_USERNAME is empty"; exit 1; }
      [[ -n "${ARTIFACTORY_OLD_PASSWORD:-}" ]] || { echo "ERROR: ARTIFACTORY_OLD_PASSWORD is empty"; exit 1; }

      echo "$ARTIFACTORY_OLD_PASSWORD" | docker login "${REGISTRY_HOSTESS_OLD}" -u "$ARTIFACTORY_OLD_USERNAME" --password-stdin

      tag_push_set_properties_old() {
        local target_tag="$1"
        echo "Creating tag (old): ${target_tag}"
        docker tag "${LOCAL_TAG_BASE}${arch}" "${ARTIFACTORY_REGISTRY_OLD}:${target_tag}"
        docker push "${ARTIFACTORY_REGISTRY_OLD}:${target_tag}"
        curl -H "Authorization: Bearer ${ARTIFACTORY_OLD_PASSWORD}" -X PUT \
          "${ARTIFACTORY_API_OLD}/${target_tag}?properties=${IMAGE_PROPERTIES}"
      }

      tag_push_set_properties_old "${TAG_NAME}"
      if [[ "${UPDATE_LATEST}" == "true" ]]; then
        tag_push_set_properties_old "${BASE_IMAGE_TAG}-${arch}-latest"
      fi

  - name: Show Results
    run: |
      source version-info
      echo "Image type built: ${BUILD_TARGET} (${arch})"
      echo "Image pushed to (new): ${REGISTRY_HOSTESS}/${REGISTRY_REPO}/${BUILD_TARGET}:${TAG_NAME}"
      echo "Image pushed to (old): ${REGISTRY_HOSTESS_OLD}/${REGISTRY_REPO}/${BUILD_TARGET}:${TAG_NAME}"
      if [[ "${UPDATE_LATEST}" == "true" ]]; then
        echo "Latest tag updated (new): ${REGISTRY_HOSTESS}/${REGISTRY_REPO}/${BUILD_TARGET}:${BASE_IMAGE_TAG}-${arch}-latest"
        echo "Latest tag updated (old): ${REGISTRY_HOSTESS_OLD}/${REGISTRY_REPO}/${BUILD_TARGET}:${BASE_IMAGE_TAG}-${arch}-latest"
      fi

      echo -e "\nBuild config for manual repro:"
      if [[ "${BUILD_TARGET}" == "nixlbench" ]]; then
        echo "git clone https://github.com/openucx/ucx.git ucx-src && (cd ucx-src && git checkout ${UCX_VERSION})"
        echo "benchmark/nixlbench/contrib/build.sh --base-image ${BASE_IMAGE} --base-image-tag ${BASE_IMAGE_TAG} --tag local-test-tag --arch ${arch} --no-cache --nixl \$WORKSPACE --ucx \$WORKSPACE/ucx-src"
      else
        NIXL_EP_FLAG=""
        if [[ "${BUILD_NIXL_EP}" == "true" ]]; then
            NIXL_EP_FLAG="--build-nixl-ep"
        fi
        echo "export UCX_REF=${UCX_VERSION}"
        echo "contrib/build-container.sh --base-image ${BASE_IMAGE} --base-image-tag ${BASE_IMAGE_TAG} --tag local-test-tag --arch ${arch} --build-type debug --no-cache ${NIXL_EP_FLAG}"
      fi

pipeline_stop:
  shell: action
  module: groovy
  run: |
    if (params.MAIL_TO) {
        def jobStatus = currentBuild.result ?: 'SUCCESS'
        def statusColor = jobStatus == 'SUCCESS' ? 'green' : 'red'

        def userName = currentBuild.rawBuild.getCause(hudson.model.Cause.UserIdCause)?.userName ?: 'schedule'

        mail(
            from: env.MAIL_FROM,
            to: params.MAIL_TO,
            subject: "Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' - ${jobStatus}",
            mimeType: 'text/html',
            body: """
                <p>Started by: <b>${userName}</b></p>
                <p>Status: <span style="color: ${statusColor};"><b>${jobStatus}</b></span></p>
                <p>Job: <a href='${env.JOB_URL}'>${env.JOB_NAME}</a></p>
                <p>Build: <a href='${env.BUILD_URL}'>#${env.BUILD_NUMBER}</a></p>
                <p>Console Output: <a href='${env.BUILD_URL}console'>Full Log</a></p>
                <p>Build Target: <b>${params.BUILD_TARGET}</b></p>
                <p>NIXL Version: <b>${params.NIXL_VERSION}</b></p>
                <p>UCX Version: <b>${params.UCX_VERSION}</b></p>
                <p>Base Image: <b>${params.BASE_IMAGE}:${params.BASE_IMAGE_TAG}</b></p>
                <p>Architectures: <b>x86_64, aarch64</b></p>
                ${params.UPDATE_LATEST ? '<p>Latest tag updated: <b>Yes</b></p>' : ''}
                ${params.BUILD_NIXL_EP ? "<p>Build NIXL EP: <b>Yes</b></p>" : ''}
            """
        )
    }
