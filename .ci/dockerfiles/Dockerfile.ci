# NIXL GPU Test Environment Dockerfile
#
# This Dockerfile creates a GPU-enabled test environment for NIXL (NVIDIA I/O eXchange Layer)
# development and testing. It provides a containerized environment with:
#
# - NVIDIA cuda-dl-base image with CUDA support
# - Non-root user setup for security
# - Sudo access for package installation and system configuration
# - Optimized for CI/CD pipeline testing
#
# Usage:
#   docker build -f .ci/dockerfiles/Dockerfile.gpu_test -t nixl-gpu-test .
#   docker run --gpus all --privileged -it nixl-gpu-test
#
# Build arguments:
#   BASE_IMAGE: Base NVIDIA cuda-dl-base image (default: nvcr.io/nvidia/cuda-dl-base:25.10-cuda13.0-devel-ubuntu24.04)
#   _UID: User ID for the non-root user (default: 148069)
#   _GID: Group ID for the user (default: 30)
#   _LOGIN: Username (default: svc-nixl)
#   _GROUP: Group name (default: hardware)
#   _HOME: Home directory path (default: /home/svc-nixl)
#   WORKSPACE: Workspace directory path
#

ARG BASE_IMAGE=nvcr.io/nvidia/cuda-dl-base:25.10-cuda13.0-devel-ubuntu24.04

FROM ${BASE_IMAGE}

# Build arguments
ARG _UID=148069
ARG _GID=30
ARG _LOGIN=svc-nixl
ARG _GROUP=hardware
ARG _HOME=/home/$_LOGIN
ARG ARCH=x86_64
ARG NIXL_INSTALL_DIR
ARG PRE_INSTALLED_ENV
ARG PRE_INSTALLED_NIXL_ENV
ARG PRE_INSTALLED_UCX_ENV
ARG UCX_VERSION=v1.20.x
# Labels for documentation
LABEL maintainer="NVIDIA NIXL Team"
LABEL description="Test environment for NIXL development"
LABEL version="1.0"

# Update package list and install required packages in one layer
RUN apt-get update && \
    apt-get install -y sudo python3 python3-pip kmod \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create group and user in one RUN command to reduce layers
RUN if ! getent group "${_GID}" > /dev/null 2>&1; then \
        groupadd -g "${_GID}" "${_GROUP}"; \
    fi && \
    useradd -u "${_UID}" -g "${_GID}" -m -s /bin/bash "${_LOGIN}" && \
    mkdir -p "${_HOME}" && \
    chown -R "${_UID}":"${_GID}" "${_HOME}"

RUN mkdir -p ${NIXL_INSTALL_DIR} && chown -R "${_UID}":"${_GID}" ${NIXL_INSTALL_DIR}
COPY --chown="${_UID}":"${_GID}" .ci/scripts/ /.ci/scripts/
COPY --chown="${_UID}":"${_GID}" .gitlab/build.sh /.gitlab/build.sh

# Configure sudo access
RUN mkdir -p /etc/sudoers.d && \
    echo "${_LOGIN} ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/${_LOGIN} && \
    chmod 440 /etc/sudoers.d/${_LOGIN} && \
    chown root:root /etc/sudoers.d/${_LOGIN}

# Switch to non-root user
USER ${_LOGIN}

# Set environment variables
ENV HOME=${_HOME}
ENV USER=${_LOGIN}

RUN /.gitlab/build.sh ${NIXL_INSTALL_DIR}
RUN sudo rm -rf /.gitlab/build.sh /.ci/scripts/
# Set working directory
WORKDIR ${_HOME}

ENTRYPOINT ["/bin/bash", "-c", "exec \"$@\"", "--"]
# Default command
CMD ["/bin/bash"]
